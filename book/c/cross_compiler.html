<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Building a C cross compiler for Theseus - The Theseus OS Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Describes the design principles and implementation details of Theseus, a companion to its source-level docs.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction to Theseus OS</a></li><li class="chapter-item expanded "><a href="../design/design.html"><strong aria-hidden="true">1.</strong> Design and Structure of Theseus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/source_code_organization.html"><strong aria-hidden="true">1.1.</strong> Source Code Repository Organization</a></li><li class="chapter-item expanded "><a href="../design/booting.html"><strong aria-hidden="true">1.2.</strong> Boot-up Procedure</a></li><li class="chapter-item expanded "><a href="../design/idea.html"><strong aria-hidden="true">1.3.</strong> Safe-language OS Principles</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.4.</strong> Intralingual Design</div></li></ol></li><li class="chapter-item expanded "><a href="../app/app.html"><strong aria-hidden="true">2.</strong> Developing a Theseus Application</a></li><li class="chapter-item expanded "><a href="../building/building.html"><strong aria-hidden="true">3.</strong> The Theseus Build Process</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building/configuration.html"><strong aria-hidden="true">3.1.</strong> Configuring Theseus</a></li><li class="chapter-item expanded "><a href="../building/rust_builds_out_of_tree.html"><strong aria-hidden="true">3.2.</strong> theseus_cargo: Building Rust Crates Out-of-Tree</a></li></ol></li><li class="chapter-item expanded "><a href="../c/programs.html"><strong aria-hidden="true">4.</strong> Experimental Support for C programs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../c/cross_compiler.html" class="active"><strong aria-hidden="true">4.1.</strong> Building a C cross compiler for Theseus</a></li><li class="chapter-item expanded "><a href="../c/tlibc.html"><strong aria-hidden="true">4.2.</strong> tlibc: Theseus's libc and how it works</a></li><li class="chapter-item expanded "><a href="../c/compiler_linker.html"><strong aria-hidden="true">4.3.</strong> Compiling and linking C programs</a></li></ol></li><li class="chapter-item expanded "><a href="../subsystems/subsystems.html"><strong aria-hidden="true">5.</strong> Overview of Key Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../subsystems/memory.html"><strong aria-hidden="true">5.1.</strong> Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../subsystems/memory_mapping.html"><strong aria-hidden="true">5.1.1.</strong> Mapping Virtual to Physical Memory</a></li><li class="chapter-item expanded "><a href="../subsystems/heap.html"><strong aria-hidden="true">5.1.2.</strong> Heap Allocators</a></li></ol></li><li class="chapter-item expanded "><a href="../subsystems/task.html"><strong aria-hidden="true">5.2.</strong> Task Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../subsystems/task_invariants.html"><strong aria-hidden="true">5.2.1.</strong> Task Management Invariants</a></li></ol></li><li class="chapter-item expanded "><a href="../subsystems/display/display.html"><strong aria-hidden="true">5.3.</strong> Display and Window Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../subsystems/display/window_manager.html"><strong aria-hidden="true">5.3.1.</strong> The Window Manager</a></li><li class="chapter-item expanded "><a href="../subsystems/display/window_tutorial.html"><strong aria-hidden="true">5.3.2.</strong> Creating and Displaying Windows</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../running/running.html"><strong aria-hidden="true">6.</strong> Running Theseus on Virtual Machines &amp; Real Hardware</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../running/virtual_machine/virtual_machine.html"><strong aria-hidden="true">6.1.</strong> Running Theseus in a Virtual Machine</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../running/virtual_machine/pci_passthrough.html"><strong aria-hidden="true">6.1.1.</strong> Using PCI device Passthrough on QEMU</a></li></ol></li><li class="chapter-item expanded "><a href="../running/headless.html"><strong aria-hidden="true">6.2.</strong> Theseus on Headless Systems</a></li><li class="chapter-item expanded "><a href="../running/usb.html"><strong aria-hidden="true">6.3.</strong> Booting via USB drive</a></li><li class="chapter-item expanded "><a href="../running/pxe.html"><strong aria-hidden="true">6.4.</strong> Booting over the network (PXE)</a></li></ol></li><li class="chapter-item expanded "><a href="../contribute/contribute.html"><strong aria-hidden="true">7.</strong> How to Contribute</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contribute/git.html"><strong aria-hidden="true">7.1.</strong> Git Guidelines</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../misc/papers_presentations.html">Papers and Presentations/Slides</a></li><li class="chapter-item expanded affix "><a href="../misc/quick_start.html">Theseus README + Quick Start ↗️</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Theseus OS Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-gcc-and-binutils-to-target-theseus-x86_64-elf"><a class="header" href="#building-gcc-and-binutils-to-target-theseus-x86_64-elf">Building GCC and Binutils to target Theseus (x86_64-elf)</a></h1>
<p><strong>We provide a script that does all of this for you;</strong> see <a href="https://github.com/theseus-os/Theseus/blob/theseus_main/scripts/install_x86_64-elf-gcc.sh">scripts/install_x86_64-elf-gcc.sh</a>, </p>
<pre><code class="language-sh">./scripts/install_x86_64-elf-gcc.sh $HOME/src $HOME/opt
</code></pre>
<hr />
<p>In this document, we refer to two directories, both of which can be set to the location of your choice:</p>
<ol>
<li><code>$SRC</code>: the directory that contains the source for gcc and binutils
<ul>
<li>For example, <code>$HOME/src/</code></li>
</ul>
</li>
<li><code>$DEST</code>: the directory that will hold our compiled gcc and binutils packages and libraries (where they will be installed)
<ul>
<li>For example, <code>$HOME/opt/</code></li>
</ul>
</li>
</ol>
<p>(Instructions were taken from <a href="https://wiki.osdev.org/Building_GCC">this tutorial on the OS dev wiki</a>.)</p>
<h2 id="1-build-a-standalone-version-of-gcc--binutils"><a class="header" href="#1-build-a-standalone-version-of-gcc--binutils">1. Build a standalone version of GCC &amp; Binutils</a></h2>
<p>Install the required packages:</p>
<pre><code class="language-sh">sudo apt-get install gcc build-essential bison flex libgmp3-dev libmpc-dev libmpfr-dev texinfo gcc-multilib
</code></pre>
<h3 id="download-and-build-gccbinutils"><a class="header" href="#download-and-build-gccbinutils">Download and build GCC/Binutils</a></h3>
<p>For this tutorial, we'll use <code>gcc</code> version <code>10.2.0</code>, released July 20, 2020,
and <code>binutils</code> version <code>2.35.1</code>, released September 19, 2020.</p>
<p>You can obtain it from many mirrors online, such as these:</p>
<ul>
<li>gcc: <a href="https://mirrors.kernel.org/gnu/gcc/gcc-10.2.0/">https://mirrors.kernel.org/gnu/gcc/gcc-10.2.0/</a></li>
<li>binutils: <a href="https://mirrors.kernel.org/gnu/binutils/">https://mirrors.kernel.org/gnu/binutils/</a></li>
</ul>
<p>Create a destination directory for the newly-built packages to be installed into:</p>
<pre><code class="language-sh">mkdir $DEST
export PREFIX=&quot;$DEST/gcc-10.2.0&quot;
</code></pre>
<p>Extract each source code package into the directory of your choice (<code>$SRC</code>), and then build binutils:</p>
<pre><code class="language-sh">mkdir build-binutils
cd build-binutils
../binutils-2.35.1/configure --prefix=&quot;$PREFIX&quot; --disable-nls --disable-werror
make -j$(nproc)
make install
</code></pre>
<p>Then go back to the <code>$SRC</code> directory and build gcc:</p>
<pre><code class="language-sh"># Use a GCC script to download all necessary prerequisites
cd gcc-10.2.0
./contrib/download_prerequisites
cd ../

mkdir build-gcc
cd build-gcc
../gcc-10.2.0/configure --prefix=&quot;$PREFIX&quot; --disable-nls --enable-languages=c,c++
make -j$(nproc)
make install
</code></pre>
<h2 id="2-build-gcc-and-binutils-again-to-cross-target-theseus-x86_64-elf"><a class="header" href="#2-build-gcc-and-binutils-again-to-cross-target-theseus-x86_64-elf">2. Build GCC and Binutils again, to cross-target Theseus (x86_64-elf)</a></h2>
<p>Now that we have a standalone build of gcc/binutils that is independent from the one installed by your host system's package manager, we can use that to build a version of gcc that inherently performs cross-compilation for a specific target, in this case, our Theseus <code>x86_64-elf</code> target.</p>
<p>Note: these instructions are based on <a href="https://wiki.osdev.org/GCC_Cross-Compiler#The_Build">this tutorial from the OS dev wiki</a>.</p>
<p>First, create a directory for the cross compiler to be built and installed into, e.g., <code>$DEST/cross</code>.</p>
<pre><code class="language-sh">mkdir $DEST/cross
export PREFIX=&quot;$DEST/cross&quot;
export TARGET=x86_64-elf
export PATH=&quot;$PREFIX/bin:$PATH&quot;
</code></pre>
<p>Second, re-build the same binutils package as above, but in a way that configures it to target Theseus. </p>
<pre><code class="language-sh">../binutils-2.35.1/configure --target=$TARGET --prefix=&quot;$PREFIX&quot; --with-sysroot --disable-nls --disable-werror
make -j$(nproc)
make install
</code></pre>
<p>Confirm that your new cross-compiler binutils package exists and is on your system PATH:</p>
<pre><code class="language-sh">which --$TARGET-as 
</code></pre>
<p>should output something like:</p>
<blockquote>
<pre><code>/home/my_username/opt/cross/bin/x86_64-elf-as
</code></pre>
</blockquote>
<p>Then go back to the <code>$SRC</code> directory and build a version of gcc that cross compiles C/C++ programs to Theseus.</p>
<pre><code class="language-sh">mkdir cross-build-gcc
cd cross-build-gcc
../gcc-10.2.0/configure --target=$TARGET --prefix=&quot;$PREFIX&quot; --disable-nls --enable-languages=c,c++ --without-headers
make all-gcc -j$(nproc)
make all-target-libgcc -j$(nproc) 
make install-gcc
make install-target-libgcc
</code></pre>
<p>Before moving on, let's check to make sure our cross-compiled gcc is working.</p>
<pre><code class="language-sh">$DEST/cross/bin/$TARGET-gcc --version
</code></pre>
<p>This should print out some information about your newly-built gcc. Add the <code>-v</code> flag to dump out even more info. </p>
<h2 id="3-re-building-gcc-without-the-default-red-zone-usage"><a class="header" href="#3-re-building-gcc-without-the-default-red-zone-usage">3. Re-building GCC without the default <code>red-zone</code> usage</a></h2>
<p>Importantly, we must disable the <a href="https://en.wikipedia.org/wiki/Red_zone_(computing)">red zone</a> in gcc entirely. When invoking gcc itself, we can simply pass the <code>-mno-red-zone</code> argument on the command line, but that doesn't affect the cross-compiled version of <code>libgcc</code> itself. Thus, in order to avoid <code>libgcc</code> functions invalidly using the non-existing red zone in Theseus, we have to build a no-red-zone version of <code>libgcc</code> in order to successfully build and link C programs for Theseus,  without <code>libgcc</code>'s methods trying to write to the red zone. </p>
<p>Note: instructions were adapted from <a href="https://wiki.osdev.org/Libgcc_without_red_zone">this tutorial</a>.</p>
<h3 id="adjusting-the-gcc-config"><a class="header" href="#adjusting-the-gcc-config">Adjusting the GCC config</a></h3>
<p>First, create a new file within the gcc source tree at <code>$SRC/gcc-10.2.0/gcc/config/i386</code>.<br />
Add the following lines to that new file and save it:</p>
<pre><code>MULTILIB_OPTIONS += mno-red-zone
MULTILIB_DIRNAMES += no-red-zone
</code></pre>
<p>Yes, even though we're building for <code>x86_64</code>, we put it in the original x86 architecture config folder called <code>i386</code>.</p>
<p>Then, instruct gcc's build process to use that new <code>multilib</code> configuration. Open the file <code>$SRC/gcc-10.2.0/gcc/config</code> and search for the following configuration lines, which starts on Line 1867 (for gcc-10.2.0):</p>
<pre><code>x86_64-*-elf*)
	tm_file=&quot;${tm_file} i386/unix.h i386/att.h dbxelf.h elfos.h newlib-stdint.h i386/i386elf.h i386/x86-64.h&quot;
	;;
</code></pre>
<p>Add a line such that it looks like this:</p>
<pre><code>x86_64-*-elf*)
	tmake_file=&quot;${tmake_file} i386/t-x86_64-elf&quot;
	tm_file=&quot;${tm_file} i386/unix.h i386/att.h dbxelf.h elfos.h newlib-stdint.h i386/i386elf.h i386/x86-64.h&quot;
	;;
</code></pre>
<p><strong>Note</strong>: the indentation before <code>tmake_file</code> must be a TAB, not spaces. </p>
<h3 id="building-gcc-again-with-no-red-zone"><a class="header" href="#building-gcc-again-with-no-red-zone">Building GCC again with no red zone</a></h3>
<p>Go back to the build directory and reconfigure and re-make <code>libgcc</code>:</p>
<pre><code class="language-sh">cd $SRC/cross-build-gcc
../gcc-10.2.0/configure --target=$TARGET --prefix=&quot;$PREFIX&quot; --disable-nls --enable-languages=c,c++ --without-headers
make all-gcc -j$(nproc)
make all-target-libgcc -j$(nproc) 
make install-gcc
make install-target-libgcc
</code></pre>
<p>To check that it worked, run the following two commands:</p>
<pre><code class="language-sh">x86_64-elf-gcc -print-libgcc-file-name
x86_64-elf-gcc -mno-red-zone -print-libgcc-file-name
</code></pre>
<p>The first one should output a path to <code>libgcc.a</code>, and the second should output a similar path with <code>no-red-zone</code> as the containing directory:</p>
<blockquote>
<pre><code>$DEST/cross/lib/gcc/x86_64-elf/10.2.0/libgcc.a
$DEST/cross/lib/gcc/x86_64-elf/10.2.0/no-red-zone/libgcc.a
</code></pre>
</blockquote>
<h2 id="appendix-how-to-use-the-no-red-zone-version-of-gcc"><a class="header" href="#appendix-how-to-use-the-no-red-zone-version-of-gcc">Appendix: How to use the no-red-zone version of GCC</a></h2>
<p>To properly use this new version of GCC that cross-compiles to the Theseus target and disables the red zone, make sure you:</p>
<ol>
<li>use the <code>x86_64-elf-gcc</code> executable that now resides in <code>$DEST/cross</code> </li>
<li>specify the <code>-mno-red-zone</code> flag, either on the command line or as part of <code>LDFLAGS</code></li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../c/programs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../c/tlibc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../c/programs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../c/tlibc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
